# This file is generated by the template.

REGISTRY	?=lcr.loongnix.cn
ORGANIZATION	?=kubesphere
REPOSITORY	?=kiali
TAG		?=2.0.0
LATEST		?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest
KIALI_SRC_URL=https://github.com/kiali/kiali.git
KIALI_OP_URL=https://github.com/kiali/kiali-operator.git
default: image

image: src/kiali src/kiali-operator
	cd src/kiali && make build-ui && make build  &&  make container-build QUAY_TAG=$(IMAGE)
	cd src/kiali-operator && make build OPERATOR_QUAY_TAG=lcr.loongnix.cn/kubesphere/kiali-operator:2.0.0 	
src/kiali:src/kiali-operator
	git clone -b v$(TAG) $(KIALI_SRC_URL) src/kiali
	cd src/kiali && git apply ../../kiali_loongarch_patch.patch
	cd src && export KIALI_SOURCES=$(PWD) && ln -s $(KIALI_SOURCES)/kiali-operator kiali/operator
src/kiali-operator:
	git clone -b v$(TAG) $(KIALI_OP_URL) src/kiali-operator
	cd src/kiali-operator && git apply ../../kiali_operator_loongarch_patch.patch
clean:
	rm -rf src
push:
	docker push $(IMAGE)
	#latest image
	@if [ $(LATEST) = "true" ]; \
		then \
		docker tag $(IMAGE) $(LATEST_IMAGE); \
		docker push $(LATEST_IMAGE); \
	fi
