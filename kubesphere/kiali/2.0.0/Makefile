# This file is generated by the template.

REGISTRY	?=lcr.loongnix.cn
ORGANIZATION	?=kubesphere
REPOSITORY	?=kiali
TAG		?=2.0.0
LATEST		?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest
KIALI_SRC_URL=https://github.com/kiali/kiali.git
KIALI_OP_URL=https://github.com/kiali/kiali-operator.git
default: image
PATCH0=kiali_operator_loongarch_patch.patch
PATCH1=kiali_loongarch_patch.patch
SOURCE0=kiali
SOURCE1=kiali-operator
image: src/kiali src/kiali-operator
	dnf install -y ./yarnpkg-1.22.21-1.lns23.noarch.rpm
	$(MAKE) -C src/$(SOURCE0) build-ui
	$(MAKE) -C src/$(SOURCE0) build
	$(MAKE) -C src/$(SOURCE0) container-build QUAY_TAG=$(IMAGE)
	$(MAKE) -C src/$(SOURCE1) build OPERATOR_QUAY_TAG=lcr.loongnix.cn/kubesphere/kiali-operator:2.0.0
	dnf remove -y yarnpkg
src/kiali:src/kiali-operator
	git clone -b v$(TAG) $(KIALI_SRC_URL) $@
	cd $@ && git apply ../../$(PATCH1)
	cd src && export KIALI_SOURCES=$(PWD) && ln -s $(KIALI_SOURCES)/kiali-operator kiali/operator
src/kiali-operator:
	git clone -b v$(TAG) $(KIALI_OP_URL) $@
	cd $@ && git apply ../../$(PATCH0)
clean:
	rm -rf src
push:
	docker push $(IMAGE)
	#latest image
	@if [ $(LATEST) = "true" ]; \
		then \
		docker tag $(IMAGE) $(LATEST_IMAGE); \
		docker push $(LATEST_IMAGE); \
	fi
