# This file is generated by the template.

REGISTRY?=lcr.loongnix.cn
ORGANIZATION?=ollama
REPOSITORY?=ollama-vulkan
TAG?=v0.6.5
LATEST?=false

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest

SOURCE_URL=https://github.com/ollama/ollama.git
PATCH1=0001-feat-introduce-Vulkan-backend-support-ollama-ollama-.patch
PATCH2=0002-cmake-fix-architecture-detection-on-non-x86-and-non-.patch
PATCH3=0003-discover-gpu_info_vulkan-stub-perfmon-check.patch
PATCH4=0004-set-compiling-stage-cflgs-and-cxxflags.patch

default: image

.PHONY: src image push clean

src:
	git clone -b $(TAG) --depth=1 $(SOURCE_URL) $@
	cd $@ && \
		git am -3 ../$(PATCH1) ../$(PATCH2) ../$(PATCH3) ../$(PATCH4)

image: src
	pushd src && \
	docker build \
		--build-arg http_proxy=$(http_proxy) \
		-f ../Dockerfile \
		--build-arg https_proxy=$(https_proxy) \
		-t $(IMAGE) . && \
		popd

push:
	docker push $(IMAGE)
	#latest image
	@if [ $(LATEST) = "true" ]; \
		then \
		docker tag $(IMAGE) $(LATEST_IMAGE); \
		docker push $(LATEST_IMAGE); \
	fi
clean:
	rm -rf ./src/
