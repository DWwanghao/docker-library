# This file is generated by the template.

REGISTRY	?=lcr.loongnix.cn
ORGANIZATION	?=istio
REPOSITORY	?=proxyv2
TAG		?=1.15.2
LATEST		?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest
PATCH=0001-add-loong64-support.patch
default: image

src: clean
	https_proxy='http://10.130.0.20:7890' git clone --depth 1 -b 1.15.2 https://github.com/istio/istio

image: src
	cd istio && git apply ../$(PATCH) && \
	go build -o ./pilot-agent -ldflags "-X main.version=$(git describe --tags) -s -w" pilot/cmd/pilot-agent/main.go && \
	wget http://cloud.loongnix.cn/releases/loongarch64/envoyproxy/envoy/1.25.0/envoy-static && chmod +x envoy-static && \
	wget https://storage.googleapis.com/istio-build/proxy/metadata_exchange-50b9c585b01ec99eeeb9c29aa4847d833b78625f.compiled.wasm && \
	wget https://storage.googleapis.com/istio-build/proxy/stats-50b9c585b01ec99eeeb9c29aa4847d833b78625f.wasm && \
	wget https://storage.googleapis.com/istio-build/proxy/metadata_exchange-50b9c585b01ec99eeeb9c29aa4847d833b78625f.wasm && \
	wget https://storage.googleapis.com/istio-build/proxy/stats-50b9c585b01ec99eeeb9c29aa4847d833b78625f.compiled.wasm && \
	mv stats-50b9c585b01ec99eeeb9c29aa4847d833b78625f.wasm stats-filter.wasm && \
	mv metadata_exchange-50b9c585b01ec99eeeb9c29aa4847d833b78625f.compiled.wasm metadata-exchange-filter.compiled.wasm && \
	mv metadata_exchange-50b9c585b01ec99eeeb9c29aa4847d833b78625f.wasm metadata-exchange-filter.wasm && \
	mv stats-50b9c585b01ec99eeeb9c29aa4847d833b78625f.compiled.wasm stats-filter.compiled.wasm && \
	docker build -t lcr.loongnix.cn/istio/distro_source:1.15.2 -f docker/Dockerfile.distro_source . && \
	docker build -t lcr.loongnix.cn/istio/base:1.15.2 -f docker/Dockerfile.base  . && \
	docker build -t lcr.loongnix.cn/istio/distroless:1.15.2 -f docker/Dockerfile.distroless . && \
	docker build -t lcr.loongnix.cn/istio/proxyv2:1.15.2 --build-arg BASE_DISTRIBUTION=distroless --build-arg BASE_VERSION=1.15.2 -f pilot/docker/Dockerfile.proxyv2 .
push:
	docker push lcr.loongnix.cn/istio/distro_source:$(TAG)
	docker push lcr.loongnix.cn/istio/base:$(TAG)
	docker push lcr.loongnix.cn/istio/distroless:$(TAG)
	docker push lcr.loongnix.cn/istio/proxyv2:$(TAG)

clean:
	rm -rf istio
