# This file is generated by the template.

REGISTRY	?=lcr.loongnix.cn
ORGANIZATION	?=istio
REPOSITORY	?=pilot
TAG		?=1.15.2
LATEST		?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest
PATCH=0001-add-loong64-support.patch
default: image

src: clean
	git clone --depth 1 -b 1.15.2 https://github.com/istio/istio

image: src
	cd istio && git apply ../$(PATCH) && \
	go build -o ./pilot-discovery -ldflags "-X main.version=$(git describe --tags) -s -w" pilot/cmd/pilot-discovery/main.go && \
	docker build -t lcr.loongnix.cn/istio/distro_source:1.15.2 -f docker/Dockerfile.distro_source . && \
	docker build -t lcr.loongnix.cn/istio/base:1.15.2 -f docker/Dockerfile.base  . && \
	docker build -t lcr.loongnix.cn/istio/distroless:1.15.2 -f docker/Dockerfile.distroless . && \
	docker build -t lcr.loongnix.cn/istio/pilot:1.15.2 --build-arg BASE_DISTRIBUTION=distroless --build-arg BASE_VERSION=1.15.2 -f pilot/docker/Dockerfile.pilot .
push:
	docker push lcr.loongnix.cn/istio/distro_source:$(TAG)
	docker push lcr.loongnix.cn/istio/base:$(TAG)
	docker push lcr.loongnix.cn/istio/distroless:$(TAG)
	docker push lcr.loongnix.cn/istio/pilot:$(TAG)

clean:
	rm -rf istio
